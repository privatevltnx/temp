<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="google-site-verification" content="tPLMObaC3EgIjoJex4M1o9yWQDS1m8g8y-Wx5vYNN8E" />
  <meta name="description" content="CodeXaurA is a powerful AI chat assistant for developers. Get instant help with coding questions, debug issues, and explore new concepts with an intelligent">
  <meta name="keywords" content="AI chat, coding assistant, AI chatbot, developer tool, code help, programming questions, CodeXaurA, chatbot, AI for developers">
  <meta name="author" content="Your Name or Company Name">

  <meta property="og:title" content="CodeXaurA ‚Äî The AI Coding Assistant">
  <meta property="og:description" content="Get instant help with coding questions, debug issues, and explore new concepts with an intelligent AI chatbot.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://voltedgebuilds.github.io/codexaura">
  <meta property="og:image" content="https://voltedgebuilds.github.io/codexaura/social-preview.png"> <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@yourtwitterhandle">
  <meta name="twitter:title" content="CodeXaurA ‚Äî The AI Coding Assistant">
  <meta name="twitter:description" content="Get instant help with coding questions, debug issues, and explore new concepts with an intelligent AI chatbot.">
  <meta name="twitter:image" content="https://voltedgebuilds.github.io/codexaura/social-preview.png">
  <title>CodeXaurA - AI Coder</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg-primary:#0e0f12;
      --bg-secondary:#16181d;
      --text-primary:#eaeaea;
      --text-secondary:#9aa4af;
      --accent:#00ffc8;
      --accent-hover:#00d7aa;
      --border:#262b33;
      --shadow:rgba(0,0,0,.45);
      --danger:#ff4d4f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#0c0d10, #0e1015 35%, #0b0c10 100%);
      color:var(--text-primary);
      overflow:hidden;
    }

    .container{display:flex;height:100%}

    /* Sidebar */
    .sidebar{
      width:0;
      background:var(--bg-secondary);
      border-right:1px solid var(--border);
      transition:width .25s ease;
      overflow:hidden;
      display:flex;flex-direction:column;
      min-width:0;
      z-index:10;
    }
    .hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .sidebar.open{width:280px}
    .sidebar .top{
      padding:16px;
      border-bottom:1px solid var(--border);
    }
    .sidebar .top button{
      width:100%;
      padding:10px 12px;
      background:var(--accent);
      color:#041013;
      border:none;border-radius:10px;
      font-weight:700;cursor:pointer;
    }
    .sidebar .top button:hover{background:var(--accent-hover)}
    .sidebar h3{
      margin:12px 16px 6px;
      color:var(--text-secondary);
      font-size:12px;letter-spacing:.12em;
      text-transform:uppercase;
    }
    #chatList{
      list-style:none;margin:0;padding:0 8px 16px;
      overflow:auto;flex:1;
    }
    #chatList li{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding:10px 12px;margin:6px 8px;border:1px solid var(--border);
      border-radius:10px;cursor:pointer;
      transition:background .15s ease,border-color .2s ease;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    #chatList li:hover{background:#1e222b;border-color:#2f3641}
    #chatList li .chat-title {
      flex-grow: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #chatList li .delete-chat-btn {
      margin-left: 10px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 5px;
      transition: color 0.2s ease, background 0.2s ease;
    }
    #chatList li .delete-chat-btn:hover {
      color: var(--danger);
      background: rgba(255, 77, 79, 0.2);
    }
    .sidebar-actions{
      border-top:1px solid var(--border);
      padding:14px 16px;
      display:flex;flex-direction:column; /* Stack settings and logout vertically */
      gap:8px;
    }
    .sidebar-footer{ /* Used for individual items within sidebar-actions */
      display:flex;align-items:center;gap:10px;
      cursor:pointer;
      padding:8px 0; /* Add some padding for click area */
    }
    .sidebar-footer:hover{background:#1c2027; border-radius: 8px;} /* Visual feedback on hover */

    /* Main */
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .header{
      height:60px;display:flex;align-items:center;gap:10px;
      padding:0 14px;border-bottom:1px solid var(--border);
      background:rgba(15,17,22,.6);backdrop-filter:blur(6px);
    }
    .menu-btn{
      display:none;font-size:22px;line-height:1;cursor:pointer;
      padding:8px 10px;border-radius:8px;border:1px solid var(--border);
      background:#12151a;
    }
    .menu-btn:active{transform:scale(.98)}
    .brand{flex:1;text-align:center;font-weight:800;letter-spacing:.02em}
    .brand span{color:var(--accent)}
    .user-actions{display:flex;align-items:center;gap:10px; position: relative;}
    .user-actions button{
      background:var(--accent);color:#041013;border:none;border-radius:10px;
      padding:8px 12px;font-weight:800;cursor:pointer;
    }
    .user-actions button:hover{background:var(--accent-hover)}
    .user-avatar{
      width:28px;height:28px;border-radius:50%;border:1px solid var(--border);
      background-size: cover; /* Ensure image covers the area */
      background-position: center; /* Center the image */
      cursor: pointer;
    }
    .user-avatar.default {
        background-color: #fff; /* Default white avatar */
    }
    .user-avatar.incognito {
        background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ee/Incognito_icon.png'); /* Incognito icon */
    }
    .ghost-btn{
      background:#151922;border:1px solid var(--border);color:var(--text-primary)
    }
    .ghost-btn:hover{border-color:#394354}

    /* User Menu Popup (removed for logout, but kept for future use if needed) */
    #userMenu {
      display: none; /* This element is now intentionally hidden */
    }

    /* Chat */
    #chat{
      flex:1;overflow:auto;padding:18px 18px 24px;
      display:flex;flex-direction:column;gap:14px;
    }
    .message{
      max-width:min(82%,720px);
      padding:12px 14px;border-radius:16px;
      box-shadow:0 2px 6px var(--shadow);
      line-height:1.5;word-wrap:break-word;white-space:pre-wrap;
    }
    .message.user{
      align-self:flex-end;background:var(--accent);color:#041013;
    }
    .message.ai{
      align-self:flex-start;background:#151922;border:1px solid var(--border);
    }
    .incognito-info {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.9em;
        padding: 10px;
        background: #2a303d;
        border-radius: 8px;
        margin: 10px auto;
        max-width: 90%;
    }


    .input-area{
      border-top:1px solid var(--border);
      padding:10px;display:flex;gap:8px;background:#0e1015;
    }
    textarea{
      flex:1;border:1px solid var(--border);border-radius:12px;
      background:#12151a;color:var(--text-primary);
      padding:12px 14px;font-size:15px;resize:none;min-height:22px;max-height:160px;overflow:auto;
    }
    .send-btn{
      padding:12px 16px;border:none;border-radius:12px;
      background:var(--accent);color:#041013;font-weight:900;cursor:pointer;
    }
    .send-btn:hover{background:var(--accent-hover)}

    /* Overlay for sidebar on mobile */
    #overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:6;
    }

    /* Auth Popup */
    #authPopup, #messagePopup{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.6);z-index:20;
    }
    .popup-content{
      width:320px;background:#12151a;border:1px solid var(--border);border-radius:14px;
      box-shadow:0 12px 40px rgba(0,0,0,.6);
      padding:18px 16px 16px;position:relative;
      animation:pop .15s ease;
    }
    @keyframes pop{from{transform:scale(.98);opacity:.7}to{transform:scale(1);opacity:1}}
    .popup-title{margin:8px 0 12px;text-align:center;font-weight:800;color:var(--accent)}
    .close-btn{
      position:absolute;top:8px;right:8px;border:none;background:transparent;
      color:var(--text-secondary);font-size:14px;padding:2px 6px;border-radius:6px;cursor:pointer;
    }
    .auth-row{display:flex;flex-direction:column;gap:8px}
    .auth-input{
      width:100%;padding:11px 12px;border:1px solid var(--border);
      border-radius:10px;background:#0f131a;color:var(--text-primary)
    }
    .action-btn{
      width:100%;padding:11px 12px;border:none;border-radius:10px;
      background:var(--accent);color:#041013;font-weight:900;cursor:pointer;margin-top:6px;
    }
    #googleBtn{
      width:100%;padding:10px 12px;border:1px solid #e6e6e6;border-radius:10px;
      background:#fff;color:#111;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px;
    }
    #googleBtn img{width:18px;height:18px}

    @media (max-width: 820px){
      .menu-btn{display:inline-block}
      .brand{font-size:16px}
      .sidebar.open{width:min(88vw,300px)}
      .message{max-width:92%}
    }
  </style>
</head>
<body>
  <h1 class="hidden">ameeen </h1>
<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="top">
      <button onclick="window.newChat()">+ New Chat</button>
    </div>
    <h3>Your Chats</h3>
    <ul id="chatList"></ul>
    <div id="sidebarActions" class="sidebar-actions">
      <!-- Settings and Logout will be dynamically loaded here -->
      <div class="sidebar-footer" onclick="window.goToSettings()">
        <span>‚öôÔ∏è</span><span>Settings</span>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <header class="header">
      <button id="menuBtn" class="menu-btn" onclick="window.toggleSidebar()">‚ò∞</button>
      <div class="brand">Code<span>XaurA</span> ‚Äî AI</div>
      <div class="user-actions" id="userArea">
        <!-- User actions content will be dynamically loaded here -->
      </div>
    </header>
    <section id="chat"></section>
    <div class="input-area">
      <textarea id="userInput" placeholder="Type your message..."></textarea>
      <button class="send-btn" onclick="window.sendMessage()">Send</button>
    </div>
  </main>
</div>

<div id="overlay" onclick="window.toggleSidebar()"></div>

<!-- Auth Popup -->
<div id="authPopup">
  <div class="popup-content">
    <button class="close-btn" onclick="window.skipAuth()">‚úñ</button>
    <div class="popup-title">Login/Sign up</div>
    <div class="auth-row">
      <button id="googleBtn" onclick="window.googleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
        Sign IN with Google
      </button>
      <button id="googleBtn" onclick="window.googleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
        Sign UP with Google
      </button>
    </div>
  </div>
</div>

<!-- Message Popup (for alerts/confirmations) -->
<div id="messagePopup">
    <div class="popup-content">
        <h3 id="messagePopupTitle" class="popup-title"></h3>
        <p id="messagePopupContent" style="text-align: center; color: var(--text-primary); margin-bottom: 20px;"></p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button id="messagePopupConfirm" class="action-btn" style="display: none;">Confirm</button>
            <button id="messagePopupClose" class="ghost-btn action-btn">OK</button>
        </div>
    </div>
</div>

<script type="module">
/************ CONFIG ************/
const supabase = window.supabase.createClient(
  "https://tfmwzeiznhfbjbhfchiu.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmbXd6ZWl6bmhmYmpiaGZjaGl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjQyOTUsImV4cCI6MjA3MDk0MDI5NX0.cuYHdMjqkSMIn31oClhDh1_BhBfTXLKKX_KHqQI-3nU"
);

/************ ELEMENTS ************/
const chatEl = document.getElementById("chat");
const userInput = document.getElementById("userInput");
const authPopup = document.getElementById("authPopup");
const userArea = document.getElementById("userArea");
const menuBtn = document.getElementById("menuBtn");
const sidebar = document.getElementById("sidebar");
const chatListEl = document.getElementById("chatList");
const overlay = document.getElementById("overlay");
const messagePopup = document.getElementById("messagePopup");
const messagePopupTitle = document.getElementById("messagePopupTitle");
const messagePopupContent = document.getElementById("messagePopupContent");
const messagePopupConfirm = document.getElementById("messagePopupConfirm");
const messagePopupClose = document.getElementById("messagePopupClose");
const sidebarActionsEl = document.getElementById("sidebarActions");


/************ STATE ************/
let currentUser = null;
let currentChatId = null;
let isIncognito = false; // New state for incognito mode

/************ HELPERS ************/
// Replaces alert() with a custom modal
function showMessage(title, content, isConfirm = false) {
    messagePopupTitle.innerText = title;
    messagePopupContent.innerText = content;
    messagePopupConfirm.style.display = isConfirm ? 'block' : 'none';
    messagePopup.style.display = 'flex';

    return new Promise(resolve => {
        messagePopupConfirm.onclick = () => {
            messagePopup.style.display = 'none';
            resolve(true);
        };
        messagePopupClose.onclick = () => {
            messagePopup.style.display = 'none';
            resolve(false);
        };
    });
}

// Make functions globally accessible for onclick attributes
window.openAuthPopup = function() {
  authPopup.style.display="flex";
}

window.skipAuth = function() {
  authPopup.style.display="none";
  // Reset user area to guest state and update sidebar actions
  userArea.innerHTML = `<button class="ghost-btn" onclick="window.openAuthPopup()">Login | Signup</button>`;
  sidebarActionsEl.innerHTML = `
      <div class="sidebar-footer" onclick="window.goToSettings()">
          <span>‚öôÔ∏è</span><span>Settings</span>
      </div>
  `;
  menuBtn.style.display = "none";
  sidebar.classList.remove("open");
  overlay.style.display = "none";
  currentUser = null;
  currentChatId = null;
  isIncognito = false; // Reset incognito mode on guest login
  chatEl.innerHTML = ""; // Clear chat
  chatListEl.innerHTML = ""; // Clear chat list
}

window.toggleSidebar = function() {
  if (!currentUser && !isIncognito) return; // Only allow sidebar toggle if logged in or in incognito
  const open = sidebar.classList.toggle("open");
  overlay.style.display = open ? "block" : "none";
}

window.goToSettings = function() { window.location.href = "settings.html"; }

function scrollChatToBottom(){ chatEl.scrollTop = chatEl.scrollHeight; }

function addMsg(role, content){
  const d = document.createElement("div");
  d.className = `message ${role === "user" ? "user" : "ai"}`;
  d.innerText = content;
  chatEl.appendChild(d);
  scrollChatToBottom();
}

/************ AUTH (EMAIL) ************/
/************ OAUTH LOGIN ************/
window.googleLogin = async function() {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: "https://voltedgebuilds.github.io/codexaura" }
  });
  if (error) {
    showMessage("Login Error", error.message);
  }
}

/************ SESSION / HEADER ************/
async function checkSession(){
  const { data: { session } } = await supabase.auth.getSession();
  if (session?.user){
    currentUser = session.user;
    const { data: userRow } = await supabase
      .from("users")
      .select("is_upgraded")
      .eq("id", currentUser.id)
      .single();
    const upgraded = !!userRow?.is_upgraded;

    // Update userArea with avatar and buttons
    userArea.innerHTML = `
      <button class="ghost-btn" id="incognitoToggleBtn" title="Toggle Incognito Mode">
          ${isIncognito ? 'üëÅÔ∏è Normal' : 'ü§´ Incognito'} <!-- Incognito icon with text -->
      </button>
      <div class="user-avatar ${isIncognito ? 'incognito' : 'default'}" title="${currentUser.email}" id="userAvatar"></div>
      ${upgraded ? "" : "<button id='upgradeBtn'>Upgrade</button>"}
    `;

    // Update sidebar actions (Settings and Logout)
    sidebarActionsEl.innerHTML = `
        <div class="sidebar-footer" onclick="window.goToSettings()">
            <span>‚öôÔ∏è</span><span>Settings</span>
        </div>
        <div class="sidebar-footer" id="logoutSidebarBtn">
            <span>üö™</span><span>Logout</span>
        </div>
    `;

    // Attach event listeners
    if (!upgraded){
      document.getElementById("upgradeBtn")?.addEventListener("click", () => {
        window.location.href = "plans.html";
      });
    }
    // No need for userAvatar click listener or userMenu popup anymore for logout
    document.getElementById("logoutSidebarBtn").addEventListener("click", window.logout); // Attach logout to sidebar button
    document.getElementById("incognitoToggleBtn")?.addEventListener("click", window.toggleIncognito);


    authPopup.style.display = "none";
    menuBtn.style.display = "inline-block";
    if (!isIncognito) {
      await loadChats();
      // After loading chats, check if there are any existing chats for the user
      // If no chats exist, automatically create a new one
      if (chatListEl.children.length === 0) {
          console.log("No existing chats found. Creating a new default chat.");
          await window.newChat(true); // Pass true to indicate it's a default initial chat
      }
    } else {
      chatEl.innerHTML = '<div class="incognito-info">You are in Incognito Mode. Chats will not be saved.</div>';
    }
  } else {
    // If no session, show auth popup and login/signup button
    openAuthPopup();
    userArea.innerHTML = `<button class="ghost-btn" onclick="window.openAuthPopup()">Login | Signup</button>`; // Ensure button is there
    sidebarActionsEl.innerHTML = `
        <div class="sidebar-footer" onclick="window.goToSettings()">
            <span>‚öôÔ∏è</span><span>Settings</span>
        </div>
    `; // Remove logout button if not logged in
    menuBtn.style.display = "none";
    currentUser = null;
    currentChatId = null;
    sidebar.classList.remove("open");
    overlay.style.display = "none";
    isIncognito = false; // Ensure incognito is off when logged out
    chatEl.innerHTML = ""; // Clear chat
    chatListEl.innerHTML = ""; // Clear chat list
  }
}

// User Menu Popup (not needed for logout anymore, kept empty)
// window.toggleUserMenu is no longer needed.

// Logout function (made global)
window.logout = async function() {
    const { error } = await supabase.auth.signOut();
    if (error) {
        showMessage("Logout Error", error.message);
    } else {
        showMessage("Logged Out", "You have been successfully logged out.");
        // Re-check session to update UI to logged-out state
        checkSession();
    }
}

// Toggle Incognito Mode (made global)
window.toggleIncognito = async function() {
    if (!currentUser) {
        await console.log("Login Required", "Please login to use Incognito Mode.");
        return;
    }
    isIncognito = !isIncognito;
    checkSession(); // Re-render header and chat area based on new incognito state
    if (isIncognito) {
        showMessage("Incognito Mode", "You are now in Incognito Mode. Your chats will not be saved.");
        currentChatId = null; // Ensure no chat is selected in incognito
        chatEl.innerHTML = '<div class="incognito-info">You are in Incognito Mode. Chats will not be saved.</div>';
    } else {
        showMessage("Incognito Mode Off", "You are no longer in Incognito Mode. Your chats will be saved if you create a new one or load an existing chat.");
        chatEl.innerHTML = ""; // Clear existing incognito message
        loadChats(); // Reload chats when exiting incognito
        // If exiting incognito and no current chat, create one (only if user has no chats at all)
        if (currentUser && chatListEl.children.length === 0) {
            await window.newChat(true);
        }
    }
}

/************ CHATS ************/
// Added an optional 'isDefaultChat' parameter to handle initial chat creation
window.newChat = async function(isDefaultChat = false) {
  if (!currentUser) {
    await showMessage("Login Required", "Please login to create and save chats.");
    return;
  }
  if (isIncognito && !isDefaultChat) { // Only prevent if not a default chat and in incognito
      await showMessage("Incognito Mode Active", "You cannot create new saved chats in Incognito Mode. Switch to normal mode to save chats.");
      return;
  }
  // Create chat with a generic title initially
  const { data, error } = await supabase
    .from("chats")
    .insert([{ user_id: currentUser.id, title: "New Chat", messages: [] }])
    .select();
  if (!error) {
    currentChatId = data[0].id;
    chatEl.innerHTML = "";
    await loadChats(); // Reload to show new chat
    await loadChat(currentChatId); // Load the newly created chat
  } else {
    showMessage("Error", "Failed to create new chat: " + error.message);
  }
}

async function loadChats() {
  if (!currentUser) return;
  const { data, error } = await supabase
    .from("chats")
    .select("id, title, created_at")
    .eq("user_id", currentUser.id)
    .order("created_at", { ascending: false });
  if (error) {
    showMessage("Error", "Failed to load chats: " + error.message);
    return;
  }
  chatListEl.innerHTML = "";
  data.forEach(c => {
    const li = document.createElement("li");
    const chatTitleSpan = document.createElement("span");
    chatTitleSpan.className = "chat-title";
    chatTitleSpan.textContent = c.title;
    chatTitleSpan.onclick = () => window.loadChat(c.id); // Use window.loadChat

    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete-chat-btn";
    deleteBtn.innerHTML = "üóëÔ∏è"; // Trash can emoji for deletion
    deleteBtn.title = "Delete Chat";
    deleteBtn.onclick = (event) => {
        event.stopPropagation(); // Prevent loading chat when clicking delete
        window.deleteChat(c.id, c.title); // Use window.deleteChat
    };

    li.appendChild(chatTitleSpan);
    li.appendChild(deleteBtn);
    chatListEl.appendChild(li);
  });
}

window.loadChat = async function(chatId) { // Made global
  if (isIncognito) {
      showMessage("Incognito Mode Active", "You cannot load saved chats in Incognito Mode. Switch to normal mode.");
      return;
  }
  const { data, error } = await supabase
    .from("chats")
    .select("messages, title")
    .eq("id", chatId)
    .single();
  if (error) {
    showMessage("Error", "Failed to load chat: " + error.message);
    return;
  }
  currentChatId = chatId;
  chatEl.innerHTML = "";
  (data.messages || []).forEach(msg => addMsg(msg.role, msg.content));
}

window.deleteChat = async function(chatId, chatTitle) { // Made global
    const confirmed = await showMessage(
        "Delete Chat",
        `Are you sure you want to delete "${chatTitle}"? This cannot be undone.`,
        true
    );
    if (!confirmed) {
        return;
    }

    const { error } = await supabase
        .from("chats")
        .delete()
        .eq("id", chatId);

    if (!error) {
        showMessage("Chat Deleted", `"${chatTitle}" has been deleted.`);
        currentChatId = null; // Deselect current chat if it was deleted
        chatEl.innerHTML = ""; // Clear chat area
        loadChats(); // Reload the chat list
    } else {
        showMessage("Error", "Failed to delete chat: " + error.message);
    }
}

// Function to generate a chat title using the LLM
async function generateChatTitle(firstMessage) {
    let chatHistory = [];
    chatHistory.push({ role: "user", parts: [{ text: `Generate a very concise (3-7 words) and descriptive title for a chat conversation starting with: "${firstMessage}". Only return the title, no other text.` }] });
    const payload = { contents: chatHistory };
    const apiKey = ""; // Canvas will provide this

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let retryCount = 0;
    const maxRetries = 3;
    const baseDelay = 1000; // 1 second

    while (retryCount < maxRetries) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if (response.status === 429 && retryCount < maxRetries - 1) {
                    const delay = baseDelay * Math.pow(2, retryCount);
                    console.log(`Rate limit hit. Retrying in ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    retryCount++;
                    continue;
                }
                throw new Error(`API error: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const title = result.candidates[0].content.parts[0].text.trim();
                // Basic clean-up for common LLM title formatting (e.g., removing quotes)
                return title.replace(/^["']|["']$/g, '');
            } else {
                throw new Error("Invalid API response structure for title generation.");
            }
        } catch (error) {
            console.error("Error during title generation API call:", error);
            if (retryCount < maxRetries - 1) {
                const delay = baseDelay * Math.pow(2, retryCount);
                console.log(`Retrying after error in ${delay}ms...`);
                await new Promise(res => setTimeout(res, delay));
                retryCount++;
            } else {
                throw error; // Re-throw if max retries reached
            }
        }
    }
    throw new Error("Max retries reached for title generation.");
}


/************ SENDING ************/
userInput.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    window.sendMessage(); // Call global function
  }
});

window.sendMessage = async function() { // Made global
  const message = userInput.value.trim();
  if (!message) return;
  addMsg("user", message);
  userInput.value = "";
  const aiDiv = document.createElement("div");
  aiDiv.classList.add("message", "ai");
  aiDiv.innerText = "Thinking...";
  chatEl.appendChild(aiDiv);
  chatEl.scrollTop = chatEl.scrollHeight;

  try {
    const res = await fetch("https://ai-coder-backend.onrender.com/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message }),
    });
    const data = await res.json();
    aiDiv.innerText = data.reply || "Error: No reply received.";

    // Save chat only if not in incognito mode and logged in and a chat is selected
    if (currentUser && currentChatId && !isIncognito) {
      let { data: chatRow, error: fetchError } = await supabase
        .from("chats")
        .select("messages, title") // Also select title to check if it's "New Chat"
        .eq("id", currentChatId)
        .single();

      if (fetchError) {
        console.error("Error fetching chat for update:", fetchError.message);
        showMessage("Save Error", "Failed to save chat history: " + fetchError.message);
        return;
      }

      const messages = chatRow?.messages || [];
      // Check if it's the first message and the title is still generic
      const isFirstMessageInNewChat = (messages.length === 0 && chatRow.title === "New Chat");

      messages.push({ role: "user", content: message });
      messages.push({ role: "ai", content: aiDiv.innerText });

      // Prepare update payload
      let updatePayload = { messages };

      // If it's the first message in a new chat, generate a title
      if (isFirstMessageInNewChat) {
          try {
              const generatedTitle = await generateChatTitle(message);
              updatePayload.title = generatedTitle;
              console.log("Generated chat title:", generatedTitle);
          } catch (titleError) {
              console.error("Error generating chat title:", titleError);
              showMessage("Title Error", "Failed to generate chat title. Defaulting to 'New Chat'.");
              // If title generation fails, it will keep "New Chat"
          }
      }

      const { error: updateError } = await supabase.from("chats").update(updatePayload).eq("id", currentChatId);
      if (updateError) {
        console.error("Error updating chat:", updateError.message);
        showMessage("Save Error", "Failed to save chat history: " + updateError.message);
      } else if (isFirstMessageInNewChat) {
          // If title was generated, refresh the chat list in the sidebar to show the new title
          loadChats();
      }
    } else if (isIncognito) {
        console.log("Not saving chat in Incognito Mode.");
    } else if (!currentUser) {
        console.log("Not saving chat: User not logged in.");
    } else if (!currentChatId) {
        console.log("Not saving chat: No chat selected.");
    }
  } catch (error) {
    aiDiv.innerText = "Error: Could not connect to AI service.";
    console.error("AI service error:", error);
    showMessage("AI Service Error", "Could not connect to the AI service. Please try again later.");
  }
  scrollChatToBottom();
}

/************ INIT ************/
checkSession();
</script>
</body>
</html>

